# 采摘工管理系统 - 功能设计与实现文档

## 一、项目概述

本项目是一个基于 NestJS + React 的现代农业用工管理系统，实现了从岗位发布、工人报名、扫码核销到薪资自动结算的 O2O 闭环管理。

## 二、已实现的核心功能

### 1. 用户信息管理模块

#### 1.1 信息录入流程
- ✅ **统一数据模板**：核心字段包含姓名、身份证号、联系方式、紧急联系人等
- ✅ **三种录入方式**：
  - **扫码录入**：扫描个人身份证（通过OCR识别）
  - **拍照录入**：拍摄身份证照片后OCR识别（`/user/register/ocr`）
  - **分步引导**：简单问题引导填写（`/user/register`）
- ✅ **数据完整性校验**：首次录入后系统自动校验数据完整性
- ✅ **唯一识别码(UID)**：首次录入后生成唯一识别码，后续报名可直接调用已有信息

#### 1.2 信息复用机制
- ✅ **UID复用**：后续报名可直接使用UID调用已有信息
- ✅ **用户自主更新**：支持用户自主更新信息（如手机号变更）
- ✅ **审核流程**：信息更新后需要重新审核（`infoAuditStatus`字段）

#### 1.3 数据安全保障
- ✅ **AES256加密存储**：敏感信息（身份证、手机号、紧急联系人）采用AES256加密算法
- ✅ **Hash索引**：使用SHA256哈希值建立索引，保证检索速度
- ✅ **数据备份机制**：每日自动备份（`BackupService`，凌晨2点执行）

**实现文件**：
- `app/backend/src/modules/user/entities/sys-user.entity.ts` - 用户实体（含紧急联系人字段）
- `app/backend/src/modules/user/user.controller.ts` - 用户控制器（OCR注册、信息更新）
- `app/backend/src/modules/user/user.service.ts` - 用户服务（信息更新、审核）
- `app/backend/src/modules/common/services/backup.service.ts` - 数据备份服务

### 2. 权限与角色管理

#### 2.1 角色定义
- ✅ **超级管理员** (`super_admin`)：系统总控，可查看所有数据，管理权限与用户
- ✅ **基地区域管理员** (`region_admin`)：负责区域内人员管理、任务分配及辖区内基地信息查看
- ✅ **基地管理员** (`base_manager`)：负责基地入驻申请、资质维护、招聘信息发布及候选人筛选
- ✅ **现场管理员** (`field_manager`)：负责现场签到与人员统计，协助数据录入与整理
- ✅ **工人** (`worker`)：普通工人角色

#### 2.2 权限分配
- ✅ **RBAC权限模型**：采用基于角色的访问控制（Role-Based Access Control）
- ✅ **权限守卫**：`RolesGuard` 实现角色权限验证
- ✅ **操作日志记录**：所有关键操作记录到 `operation_log` 表，可追溯权限变更与数据操作

**实现文件**：
- `app/backend/src/modules/user/entities/sys-user.entity.ts` - 用户角色枚举
- `app/backend/src/modules/auth/guards/roles.guard.ts` - 角色权限守卫
- `app/backend/src/modules/common/entities/operation-log.entity.ts` - 操作日志实体
- `app/backend/src/modules/common/services/operation-log.service.ts` - 操作日志服务

### 3. 报名与签到流程

#### 3.1 报名流程
- ✅ **小程序/公众号报名**：用户通过接口报名，选择参与日期、工种及目标基地
- ✅ **个人专属二维码**：报名成功后系统自动生成个人专属二维码，包含活动信息、UID及所选基地信息
- ✅ **报名确认短信**：系统发送报名确认短信，包含签到二维码链接

#### 3.2 现场签到流程
- ✅ **扫码签到**：管理人员使用移动终端扫描用户二维码
- ✅ **自动匹配**：系统自动匹配用户信息、所选基地信息，标记签到状态
- ✅ **实时同步**：签到数据实时同步至云端
- ✅ **离线签到**：支持离线签到数据同步（`/attendance/sync`）

#### 3.3 异常处理
- ✅ **未注册用户**：弹出注册界面，支持现场拍照/OCR录入
- ✅ **信息不全用户**：提示补充信息，完成后才能签到
- ✅ **签到数据异常**：自动标记并提醒管理员复核

**实现文件**：
- `app/backend/src/modules/attendance/attendance.controller.ts` - 考勤控制器
- `app/backend/src/modules/attendance/attendance.service.ts` - 考勤服务（含代报名、短信发送）
- `app/backend/src/modules/common/services/sms.service.ts` - 短信服务

### 4. 工资结算流程

#### 4.1 工时记录
- ✅ **实际工作时长记录**：现场管理人员记录实际工作时长与完成量
- ✅ **关联基地信息**：工时记录关联对应基地信息
- ✅ **分段记录**：支持分段记录（如上午/下午分开记录）

#### 4.2 工资计算
- ✅ **多种计算方式**：支持固定工资、计件工资、时薪等多种计算方式
- ✅ **自动计算**：根据工种单价、工时、完成量自动计算
- ✅ **单价快照**：系统自动保存单价快照，防止历史数据篡改
- ✅ **自动校验**：系统自动校验计算结果，避免异常数据

#### 4.3 工资发放
- ✅ **工资确认单**：生成工资确认单，工人签字确认
- ✅ **多种发放方式**：支持线下现金发放与线上转账两种方式
- ✅ **发放凭证**：发放记录拍照存档，系统生成发放凭证，同步至对应基地档案

**实现文件**：
- `app/backend/src/modules/salary/salary.service.ts` - 工资计算服务
- `app/backend/src/modules/salary/services/salary-calculator.strategy.ts` - 工资计算策略
- `app/backend/src/modules/salary/entities/salary-payment.entity.ts` - 工资支付实体
- `app/backend/src/modules/salary/services/salary-payment.service.ts` - 工资支付服务

### 5. 基地模块

#### 5.1 功能规划

##### 5.1.1 基地信息展示
- ✅ **核心信息展示**：营业资质、环境照片、联系方式、经营类别
- ✅ **多维度筛选**：按经营类别、所在地区、招聘状态筛选

##### 5.1.2 招聘信息发布
- ✅ **详细招聘内容**：岗位名称、招聘要求、招聘人数、工作周期、薪资标准、工作内容、福利保障
- ✅ **图文并茂展示**：可上传工作场景视频、产区实景图
- ✅ **有效期管理**：招聘信息设置有效期，到期自动下架或提醒续期

##### 5.1.3 双向选择机制
- ✅ **合作申请**：基地管理员可向区域管理员/超级管理员提交合作申请
- ✅ **候选人筛选**：管理员可查看申请详情及对应候选人池，筛选匹配候选人
- ✅ **申请审核**：管理员可回复同意合作/拒绝并说明原因

##### 5.1.4 资源整合与推荐
- ✅ **智能推荐**：基于用户历史数据和岗位画像，利用复杂SQL查询推荐匹配岗位
- ✅ **推荐逻辑**：区域匹配(40%) + 历史偏好(30%) + 活跃岗位(30%)

#### 5.2 交互流程

##### 5.2.1 基地入驻
- ✅ **入驻申请**：基地提交入驻申请，填写基本信息、上传资质材料
- ✅ **审核流程**：超级管理员在3个工作日内完成资质核验
- ✅ **专属板块**：审核通过后，系统为基地分配专属管理后台与展示页面

##### 5.2.2 招聘发布
- ✅ **招聘详情**：基地管理员填写招聘详情，设置筛选条件
- ✅ **自动校验**：系统自动校验招聘信息完整性
- ✅ **智能匹配推送**：系统根据招聘条件，筛选潜在候选人并发送通知

##### 5.2.3 用户申请
- ✅ **岗位申请**：用户浏览基地展示页面及招聘信息，提交申请
- ✅ **申请进度**：用户可在个人中心查看申请进度
- ✅ **反馈接收**：接收基地面试安排、录用结果等反馈

**实现文件**：
- `app/backend/src/modules/base/base.controller.ts` - 基地控制器
- `app/backend/src/modules/base/base.service.ts` - 基地服务
- `app/backend/src/modules/base/entities/base-cooperation.entity.ts` - 基地合作申请实体
- `app/backend/src/modules/base/entities/job-application.entity.ts` - 岗位申请实体
- `app/backend/src/modules/base/services/job-application.service.ts` - 岗位申请服务
- `app/backend/src/modules/base/services/base-cooperation.service.ts` - 基地合作服务
- `app/backend/src/modules/recommendation/recommendation.service.ts` - 智能推荐服务

### 6. 系统扩展与接口设计

#### 6.1 接口预留

##### 6.1.1 车辆信息接口
- 📋 **预留**：未来可对接包车管理系统

##### 6.1.2 考勤设备接口
- 📋 **预留**：支持对接打卡机、定位设备

##### 6.1.3 财务系统接口
- 📋 **预留**：可与现有财务系统数据互通

##### 6.1.4 基地相关接口
- ✅ **地图接口预留**：`MapService` 预留对接高德/百度地图，实现基地定位与导航
- 📋 **招聘平台接口**：可选对接第三方招聘渠道，扩展招聘范围

##### 6.1.5 评价系统接口
- ✅ **评价实体预留**：`BaseRating` 实体预留，未来可新增用户对基地的评价接口，完善基地口碑体系

**实现文件**：
- `app/backend/src/modules/base/services/map.service.ts` - 地图服务（预留）
- `app/backend/src/modules/base/entities/base-rating.entity.ts` - 基地评价实体（预留）

#### 6.2 多终端支持
- ✅ **小程序端**：用户报名、信息查询、基地浏览、岗位申请
- ✅ **管理端**：后台管理、数据统计、基地入驻审核、权限配置
- ✅ **移动管理端**：现场签到、任务管理、基地信息查看
- ✅ **基地管理端**：入驻申请、招聘发布、候选人筛选、反馈处理

## 三、本次改动步骤和实现的功能

### 改动步骤

#### 第一步：完善用户信息管理
1. **添加紧急联系人字段**：
   - 在 `SysUser` 实体中添加 `emergencyContact` 和 `emergencyPhone` 字段
   - 添加 `emergencyPhoneHash` 用于快速检索
   - 添加 `infoAuditStatus` 字段用于信息审核状态管理

2. **实现信息更新和审核流程**：
   - 创建 `UpdateUserDto` 用于用户信息更新
   - 在 `UserService` 中实现 `update()` 方法，支持信息更新
   - 实现 `auditInfo()` 方法，支持管理员审核用户信息更新
   - 信息更新后自动设置为待审核状态

3. **实现三种录入方式**：
   - **手动填写**：`/user/register` 接口（已存在）
   - **OCR拍照录入**：新增 `/user/register/ocr` 接口，调用腾讯云OCR识别身份证
   - **完成OCR注册**：新增 `/user/register/complete` 接口，补充完整信息

#### 第二步：实现操作日志和数据备份
1. **创建操作日志实体和服务**：
   - 创建 `OperationLog` 实体，记录所有关键操作
   - 创建 `OperationLogService` 服务，提供日志记录和查询功能
   - 支持记录操作类型、资源类型、操作前后数据等

2. **实现数据备份机制**：
   - 创建 `BackupService` 服务
   - 使用 `@nestjs/schedule` 实现每日凌晨2点自动备份
   - 预留手动备份接口

#### 第三步：实现短信发送功能
1. **创建短信服务**：
   - 创建 `SmsService` 服务
   - 实现 `sendSignupConfirmation()` 方法，发送报名确认短信
   - 实现 `sendAuditNotification()` 方法，发送审核结果通知
   - 预留真实短信服务集成接口（腾讯云SMS/阿里云SMS）

#### 第四步：实现代报名功能
1. **扩展报名接口**：
   - 在 `CreateSignupDto` 中添加 `proxyUserIds` 字段（可选）
   - 在 `AttendanceService.signup()` 中实现代报名逻辑
   - 支持一人替最多两人报名
   - 代报名记录标记 `isProxy: true` 和 `proxyUserId`

#### 第五步：完善工资结算
1. **创建工资支付实体和服务**：
   - 创建 `SalaryPayment` 实体，记录工资发放信息
   - 创建 `SalaryPaymentService` 服务
   - 实现 `createPayment()` - 创建支付记录
   - 实现 `confirmPayment()` - 工人确认签字
   - 实现 `completePayment()` - 完成发放并上传凭证

#### 第六步：实现基地双向选择机制
1. **创建基地合作申请实体和服务**：
   - 创建 `BaseCooperation` 实体
   - 创建 `BaseCooperationService` 服务
   - 实现 `create()` - 区域管理员/超级管理员提交合作申请
   - 实现 `review()` - 基地管理员审核合作申请
   - 实现查询方法：`getCooperationsByBase()` 和 `getCooperationsByApplicant()`

2. **在BaseController中添加接口**：
   - `POST /base/cooperation` - 提交合作申请
   - `PATCH /base/cooperation/:id/review` - 审核合作申请
   - `GET /base/:id/cooperations` - 获取基地合作申请列表

#### 第七步：实现用户申请岗位功能
1. **创建岗位申请实体和服务**：
   - 创建 `JobApplication` 实体
   - 创建 `JobApplicationService` 服务
   - 实现 `create()` - 用户申请岗位
   - 实现 `review()` - 基地管理员审核申请
   - 实现查询方法：`getApplicationsByJob()` 和 `getApplicationsByUser()`

2. **在BaseController中添加接口**：
   - `POST /base/jobs/:jobId/apply` - 用户申请岗位
   - `GET /base/jobs/:jobId/applications` - 获取岗位申请列表
   - `PATCH /base/applications/:id/review` - 审核岗位申请

#### 第八步：添加接口预留
1. **地图服务预留**：
   - 创建 `MapService` 服务
   - 预留 `geocode()` - 地址解析
   - 预留 `calculateDistance()` - 距离计算
   - 预留 `getRoute()` - 导航路线

2. **评价系统预留**：
   - 创建 `BaseRating` 实体
   - 预留评价相关字段和关系

#### 第九步：更新模块配置
1. **更新CommonModule**：
   - 添加 `SmsService`、`OperationLogService`、`BackupService`
   - 注册 `OperationLog` 实体
   - 添加 `ScheduleModule` 支持定时任务

2. **更新BaseModule**：
   - 添加 `JobApplication`、`BaseCooperation` 实体
   - 添加 `JobApplicationService`、`BaseCooperationService` 服务

3. **更新AttendanceModule**：
   - 添加 `QrCodeModule` 依赖

4. **更新SalaryModule**：
   - 添加 `SalaryPayment` 实体
   - 添加 `SalaryPaymentService` 服务

5. **更新AppModule**：
   - 注册所有新实体到 TypeORM

### 实现的功能总结

✅ **用户信息管理**：
- 紧急联系人字段
- 信息更新和审核流程
- 三种录入方式（手动、OCR、分步引导）

✅ **权限与角色管理**：
- RBAC权限模型
- 操作日志记录

✅ **报名与签到流程**：
- 报名确认短信
- 代报名功能（一人替最多两人）
- 离线签到同步

✅ **工资结算流程**：
- 工资确认单
- 发放凭证
- 多种发放方式

✅ **基地模块**：
- 双向选择机制（合作申请）
- 用户申请岗位功能
- 智能推荐

✅ **系统扩展**：
- 数据备份机制（每日自动备份）
- 地图接口预留
- 评价系统接口预留

## 四、数据库表结构

### 新增表

1. **operation_log** - 操作日志表
   - 记录所有关键操作，支持追溯

2. **job_application** - 岗位申请表
   - 用户申请岗位记录

3. **base_cooperation** - 基地合作申请表
   - 区域管理员/超级管理员申请与基地合作

4. **salary_payment** - 工资支付表
   - 记录工资发放信息、确认签字、发放凭证

5. **base_rating** - 基地评价表（预留）
   - 用户对基地的评价

### 修改表

1. **sys_user** - 用户表
   - 新增：`emergency_contact_enc` - 紧急联系人（加密）
   - 新增：`emergency_phone_enc` - 紧急联系人电话（加密）
   - 新增：`emergency_phone_hash` - 紧急联系人电话哈希
   - 新增：`info_audit_status` - 信息审核状态

## 五、API接口清单

### 用户管理接口
- `POST /user/register` - 用户注册（手动填写）
- `POST /user/register/ocr` - OCR拍照录入
- `POST /user/register/complete` - 完成OCR注册
- `GET /user/profile` - 获取个人信息
- `PATCH /user/profile` - 更新个人信息
- `PATCH /user/:id/audit` - 审核用户信息更新

### 考勤管理接口
- `POST /attendance/signup` - 工人报名（支持代报名）
- `GET /attendance/qrcode` - 获取个人身份码
- `POST /attendance/checkin` - 现场扫码签到
- `POST /attendance/sync` - 离线数据批量同步

### 基地管理接口
- `POST /base` - 创建基地
- `GET /base` - 获取基地列表
- `GET /base/:id` - 获取基地详情
- `PATCH /base/:id/audit` - 审核基地
- `POST /base/:id/jobs` - 发布招聘岗位
- `GET /base/:id/jobs` - 获取基地的招聘岗位列表
- `POST /base/jobs/:jobId/apply` - 用户申请岗位
- `GET /base/jobs/:jobId/applications` - 获取岗位申请列表
- `PATCH /base/applications/:id/review` - 审核岗位申请
- `POST /base/cooperation` - 提交基地合作申请
- `PATCH /base/cooperation/:id/review` - 审核基地合作申请
- `GET /base/:id/cooperations` - 获取基地合作申请列表

### 工资管理接口
- `POST /salary/calculate` - 计算工资
- `POST /salary/payment` - 创建支付记录
- `PATCH /salary/payment/:id/confirm` - 确认支付（签字）
- `PATCH /salary/payment/:id/complete` - 完成支付（上传凭证）

## 六、技术栈

### 后端
- **框架**：NestJS 10.x
- **ORM**：TypeORM 0.3.x
- **数据库**：MySQL 8.0
- **加密**：AES-256-CBC（crypto-js）
- **定时任务**：@nestjs/schedule
- **OCR**：腾讯云OCR（预留）
- **对象存储**：腾讯云COS

### 前端
- **框架**：React 19.x
- **构建工具**：Vite 6.x
- **API生成**：Orval
- **UI库**：TailwindCSS

## 七、后续优化建议

1. **短信服务集成**：集成真实的短信服务（腾讯云SMS/阿里云SMS）
2. **地图服务集成**：集成高德地图或百度地图API
3. **评价系统实现**：完善基地评价功能
4. **数据备份优化**：实现真实的数据库备份和云存储上传
5. **微信小程序端**：开发微信小程序前端
6. **移动管理端**：开发移动管理端应用
7. **性能优化**：添加Redis缓存，优化查询性能
8. **监控告警**：添加系统监控和告警机制
9. **多端统一体验**：完善各用户端的操作流程指引和交互细节

---

## 八、不同用户端操作流程梳理

### 1. 工人端（微信小程序）

1. **注册与登录**
   - 打开小程序首页 → 点击「注册」
   - 填写姓名、身份证号、手机号、紧急联系人信息 → 提交
   - 返回首页 → 点击「登录」→ 输入手机号 + 身份证后 6 位 → 登录成功后跳转首页，展示「欢迎回来，张三」等个性化信息
2. **浏览基地与岗位**
   - 底部 Tab「基地」→ 查看基地列表，可按类别筛选（水果/蔬菜/其他）
   - 点击某个基地进入详情页，查看基地介绍与招聘岗位列表
   - 点击某个岗位可查看岗位详情，如工资方式、工作内容、福利等
3. **报名与签到**
   - 在岗位详情页点击「报名」→ 创建当天或指定日期的报名记录
   - 到达现场后，管理端或基地端扫描工人「我的码」页面中的个人二维码完成签到
   - 若无智能手机，可由现场管理员通过「代报名」功能为其报名
4. **查看个人信息与记录**
   - 底部 Tab「我的」→ 查看个人基本信息、紧急联系人信息与审核状态
   - 后续可扩展查看个人报名记录、考勤记录与工资结算记录

### 2. 超级管理员 / 区域管理员端（Web 管理端）

1. **账号登录**
   - 通过 Web 管理后台登录（角色为 `super_admin` 或 `region_admin`）
2. **基地入驻与审核**
   - 在「基地管理」模块中查看「待审核基地」列表
   - 审核基地提交的营业执照与资质信息（通过 / 驳回并填写原因）
3. **区域用工调度与合作申请**
   - 根据区域用工需求创建或审核「基地合作申请」
   - 结合历史用工数据与智能推荐结果，为优质基地匹配长期合作工人或队伍
4. **全局统计与报表**
   - 查看各区域基地数量、岗位发布情况、报名/签到数据与工资发放汇总

### 3. 基地管理员端（Web 管理端）

1. **基地信息维护**
   - 登录后台后在「基地资料」中维护基地基本信息（地址、联系方式、介绍、图片/视频等）
2. **招聘岗位发布与管理**
   - 在「岗位管理」中发布新岗位，配置薪资模式（固定/计件/时薪）、招聘人数、周期等
   - 管理岗位状态（招聘中 / 已满员 / 已下线），支持一键续期
3. **候选人筛选与沟通**
   - 在「岗位申请」列表中查看工人申请记录
   - 根据申请信息、历史考勤与工资记录筛选合适候选人，并记录沟通结果
4. **现场用工与工资结算**
   - 与现场管理员配合，核实报名名单与签到情况
   - 在「工资管理」中查看工资草稿、确认单与支付记录

### 4. 现场管理员端（移动管理端 / Web H5）

1. **现场签到管理**
   - 打开「签到管理」界面，使用设备摄像头扫描工人小程序中的二维码
   - 对未报名或信息不全的工人，引导使用「快速登记」或「代报名」功能补全信息
2. **考勤与异常处理**
   - 实时查看今日已签到 / 未到 / 未注册列表
   - 对异常记录（重复签到、非本基地报名等）进行标记与备注，交由上级复核
3. **工时与产量记录**
   - 按班次（上午 / 下午 / 夜班）记录工人实际工作时长或完成量
   - 提交给工资结算模块生成工资草稿

### 5. 财务 / 出纳端（工资发放端）

1. **工资草稿审核**
   - 在「工资管理」中查看按日 / 按工人维度的工资草稿
   - 核对工时与单价，发现异常数据时退回现场管理员修改
2. **工资确认与发放**
   - 生成「工资确认单」，由工人签字确认（线下或电子签名）
   - 选择发放方式：现金 / 转账，并上传发放凭证照片（如转账截图）
3. **对账与归档**
   - 保留每笔工资记录的确认单与发放凭证
   - 按基地、时间区间输出对账报表，支持导出为 Excel / PDF（后续扩展）

---

**文档版本**：v1.1  
**最后更新**：2026-01-28  
**作者**：AI Assistant
