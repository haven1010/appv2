# 采摘通系统测试指南

## 一、环境准备

### 1. 后端服务启动

```bash
cd app/backend

# 安装依赖（如果还没安装）
npm install

# 启动后端服务
npm run start:dev
```

后端服务将在 `http://localhost:3001` 启动，Swagger文档地址：`http://localhost:3001/docs`

### 2. 数据库配置

确保MySQL数据库已启动，并已导入 `app/backend/picking_pass_db_final.sql` 文件。

在 `app/backend` 目录下创建 `.env` 文件：

```env
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=pickpass_db

JWT_SECRET=super_secret_key_for_course_design_2025
AES_KEY=CaiZhiTong2025AES32ByteKey123456
AES_IV=0123456789012345
```

### 3. 微信开发者工具配置

1. 打开微信开发者工具
2. 选择"导入项目"
3. 项目目录选择：`/Users/yurukuangliu/Desktop/移动应用开发/数据库应用系统大作业/miniprogram`
4. AppID：填写你的小程序AppID（或选择"测试号"）
5. 点击"导入"

### 4. 配置小程序API地址

编辑 `miniprogram/app.js`，修改 `baseUrl`：

```javascript
globalData: {
  baseUrl: 'http://localhost:3001/api', // 开发环境
  // 如果使用真机调试，需要改为你的内网IP，如：'http://192.168.1.100:3001/api'
}
```

**注意**：如果使用真机调试，需要：
1. 确保手机和电脑在同一WiFi网络
2. 将 `baseUrl` 改为电脑的内网IP地址
3. 在微信开发者工具中，点击"详情" -> "本地设置" -> 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

## 二、功能测试清单

### ✅ 1. 用户注册功能

#### 1.1 手动填写注册
- **路径**：小程序 -> 首页 -> 注册
- **测试步骤**：
  1. 填写姓名、身份证号、手机号
  2. 填写紧急联系人信息（可选）
  3. 选择角色（worker）
  4. 提交注册
- **预期结果**：注册成功，返回UID

#### 1.2 OCR拍照注册
- **API测试**：使用Postman或Swagger测试
- **接口**：`POST /api/user/register/ocr`
- **请求体**：
```json
{
  "imageUrl": "https://example.com/idcard.jpg",
  "side": "FRONT",
  "emergencyContact": "李四-配偶",
  "emergencyPhone": "13900139000"
}
```
- **预期结果**：返回OCR识别结果，包含姓名和身份证号

### ✅ 2. 用户登录功能

- **路径**：小程序 -> 首页 -> 登录
- **测试步骤**：
  1. 输入已注册的手机号
  2. 输入身份证后6位
  3. 点击登录
- **预期结果**：登录成功，跳转到首页，显示用户信息

### ✅ 3. 个人信息管理

#### 3.1 查看个人信息
- **路径**：小程序 -> 我的
- **预期结果**：显示姓名、UID、手机号等信息

#### 3.2 更新个人信息
- **API测试**：`PATCH /api/user/profile`
- **请求头**：`Authorization: Bearer {token}`
- **请求体**：
```json
{
  "phone": "13800138001",
  "emergencyContact": "王五-朋友",
  "emergencyPhone": "13900139001"
}
```
- **预期结果**：更新成功，`infoAuditStatus` 变为 0（待审核）

#### 3.3 审核用户信息更新
- **API测试**：`PATCH /api/user/{userId}/audit`
- **请求头**：`Authorization: Bearer {admin_token}`
- **请求体**：
```json
{
  "status": 1,
  "reason": "审核通过"
}
```
- **预期结果**：审核成功，用户信息状态更新

### ✅ 4. 基地管理功能

#### 4.1 查看基地列表
- **路径**：小程序 -> 基地
- **API测试**：`GET /api/base?category=1&regionCode=330100`
- **预期结果**：返回符合条件的基地列表

#### 4.2 查看基地详情
- **路径**：小程序 -> 基地 -> 点击某个基地
- **API测试**：`GET /api/base/{id}`
- **预期结果**：返回基地详细信息，包括招聘岗位

#### 4.3 创建基地（管理员）
- **API测试**：`POST /api/base`
- **请求头**：`Authorization: Bearer {admin_token}`
- **请求体**：
```json
{
  "baseName": "测试农场",
  "licenseUrl": "https://example.com/license.jpg",
  "contactPhone": "13800138000",
  "category": 1,
  "regionCode": 330100,
  "address": "杭州市西湖区",
  "description": "{\"images\": [\"https://example.com/img1.jpg\"]}"
}
```
- **预期结果**：创建成功，状态为待审核

#### 4.4 审核基地
- **API测试**：`PATCH /api/base/{id}/audit`
- **请求体**：`{ "status": 1 }` （1=通过，2=拒绝）
- **预期结果**：审核状态更新

### ✅ 5. 招聘岗位功能

#### 5.1 发布招聘岗位
- **API测试**：`POST /api/base/{baseId}/jobs`
- **请求体**：
```json
{
  "jobTitle": "水果采摘工",
  "recruitCount": 10,
  "payType": "hourly",
  "hourlyRate": 25,
  "workCycle": "daily",
  "jobDescription": "负责水果采摘工作",
  "requirements": "身体健康，能吃苦耐劳"
}
```
- **预期结果**：岗位发布成功

#### 5.2 查看岗位列表
- **API测试**：`GET /api/base/{baseId}/jobs`
- **预期结果**：返回该基地的所有招聘岗位

#### 5.3 用户申请岗位
- **API测试**：`POST /api/base/jobs/{jobId}/apply`
- **请求体**：
```json
{
  "baseId": 1,
  "note": "我有相关工作经验"
}
```
- **预期结果**：申请成功，状态为待处理

#### 5.4 查看岗位申请列表（基地管理员）
- **API测试**：`GET /api/base/jobs/{jobId}/applications`
- **预期结果**：返回该岗位的所有申请记录

#### 5.5 审核岗位申请
- **API测试**：`PATCH /api/base/applications/{applicationId}/review`
- **请求体**：
```json
{
  "status": 1,
  "rejectReason": ""
}
```
- **预期结果**：申请状态更新（1=通过，2=拒绝）

### ✅ 6. 报名与签到功能

#### 6.1 工人报名
- **API测试**：`POST /api/attendance/signup`
- **请求体**：
```json
{
  "baseId": 1,
  "jobId": 1,
  "workDate": "2025-12-22",
  "proxyUserIds": [2, 3]  // 可选：代报名用户ID
}
```
- **预期结果**：报名成功，发送确认短信

#### 6.2 获取个人二维码
- **路径**：小程序 -> 我的码
- **API测试**：`GET /api/attendance/qrcode`
- **预期结果**：返回加密的二维码内容

#### 6.3 现场扫码签到
- **API测试**：`POST /api/attendance/checkin`
- **请求体**：
```json
{
  "qrContent": "{加密的二维码内容}",
  "baseId": 1
}
```
- **预期结果**：签到成功，状态更新为已签到

#### 6.4 离线签到同步
- **API测试**：`POST /api/attendance/sync`
- **请求体**：
```json
{
  "records": [
    {
      "uid": "U123456",
      "baseId": 1,
      "date": "2025-12-22",
      "checkinTime": "2025-12-22T08:00:00Z"
    }
  ]
}
```
- **预期结果**：批量同步成功

### ✅ 7. 工资结算功能

#### 7.1 计算工资
- **API测试**：`POST /api/salary/calculate`
- **请求体**：
```json
{
  "signupId": 1,
  "duration": 8,
  "count": 100
}
```
- **预期结果**：计算工资并创建工资记录

#### 7.2 创建支付记录
- **API测试**：`POST /api/salary/payment`
- **请求体**：
```json
{
  "salaryId": 1,
  "paymentMethod": "cash",
  "paidBy": 1
}
```
- **预期结果**：创建支付记录

#### 7.3 确认支付（签字）
- **API测试**：`PATCH /api/salary/payment/{paymentId}/confirm`
- **请求体**：
```json
{
  "signatureUrl": "https://example.com/signature.jpg"
}
```
- **预期结果**：支付状态更新为已确认

#### 7.4 完成支付（上传凭证）
- **API测试**：`PATCH /api/salary/payment/{paymentId}/complete`
- **请求体**：
```json
{
  "voucherUrl": "https://example.com/voucher.jpg",
  "paidBy": 1
}
```
- **预期结果**：支付完成，工资状态更新为已发放

### ✅ 8. 基地合作申请功能

#### 8.1 提交合作申请（区域管理员）
- **API测试**：`POST /api/base/cooperation`
- **请求体**：
```json
{
  "baseId": 1,
  "requirement": "需要10名水果采摘工，工作周期7天"
}
```
- **预期结果**：申请提交成功

#### 8.2 查看合作申请列表
- **API测试**：`GET /api/base/{baseId}/cooperations`
- **预期结果**：返回该基地的所有合作申请

#### 8.3 审核合作申请
- **API测试**：`PATCH /api/base/cooperation/{cooperationId}/review`
- **请求体**：
```json
{
  "status": 1,
  "rejectReason": ""
}
```
- **预期结果**：申请状态更新

### ✅ 9. 智能推荐功能

- **API测试**：`GET /api/recommendation/bases`
- **请求头**：`Authorization: Bearer {token}`
- **预期结果**：返回推荐基地列表，按匹配度排序

### ✅ 10. 操作日志功能

- **API测试**：查看数据库 `operation_log` 表
- **预期结果**：所有关键操作都有日志记录

### ✅ 11. 数据备份功能

- **检查**：查看 `app/backend` 目录下的 `backups` 文件夹（如果配置了备份路径）
- **预期结果**：每日凌晨2点自动备份（需要服务器运行）

## 三、测试数据准备

### 创建测试用户

使用Swagger或Postman调用注册接口：

```json
POST /api/user/register
{
  "name": "测试用户",
  "idCard": "330106199001011234",
  "phone": "13800138000",
  "roleKey": "worker",
  "emergencyContact": "李四-配偶",
  "emergencyPhone": "13900139000"
}
```

### 创建测试基地

```json
POST /api/base
{
  "baseName": "测试农场",
  "licenseUrl": "https://example.com/license.jpg",
  "contactPhone": "13800138000",
  "category": 1,
  "regionCode": 330100,
  "address": "杭州市西湖区",
  "description": "{\"images\": [\"https://example.com/img1.jpg\"]}"
}
```

## 四、常见问题

### 1. 小程序无法连接后端

**问题**：小程序请求失败，提示网络错误

**解决方案**：
- 检查后端服务是否启动
- 检查 `app.js` 中的 `baseUrl` 是否正确
- 如果使用真机调试，确保手机和电脑在同一WiFi
- 在微信开发者工具中关闭域名校验

### 2. 登录后token过期

**问题**：登录一段时间后，请求返回401

**解决方案**：
- 检查JWT_SECRET配置
- 重新登录获取新token

### 3. OCR功能无法使用

**问题**：OCR接口返回错误

**解决方案**：
- 检查腾讯云OCR配置（TENCENT_SECRET_ID, TENCENT_SECRET_KEY）
- 确保图片URL可访问
- 开发环境可以使用模拟数据

### 4. 短信功能无法使用

**问题**：短信发送失败

**解决方案**：
- 当前为模拟模式，不会真实发送短信
- 如需真实发送，需要配置短信服务（腾讯云SMS/阿里云SMS）

## 五、测试报告模板

### 功能测试结果

| 功能模块 | 测试项 | 状态 | 备注 |
|---------|--------|------|------|
| 用户注册 | 手动注册 | ✅ | 通过 |
| 用户注册 | OCR注册 | ✅ | 通过 |
| 用户登录 | 手机号+身份证后6位 | ✅ | 通过 |
| 信息更新 | 更新个人信息 | ✅ | 通过 |
| 信息审核 | 审核信息更新 | ✅ | 通过 |
| 基地管理 | 查看基地列表 | ✅ | 通过 |
| 基地管理 | 创建基地 | ✅ | 通过 |
| 基地管理 | 审核基地 | ✅ | 通过 |
| 岗位管理 | 发布岗位 | ✅ | 通过 |
| 岗位管理 | 申请岗位 | ✅ | 通过 |
| 报名签到 | 工人报名 | ✅ | 通过 |
| 报名签到 | 获取二维码 | ✅ | 通过 |
| 报名签到 | 扫码签到 | ✅ | 通过 |
| 工资结算 | 计算工资 | ✅ | 通过 |
| 工资结算 | 支付流程 | ✅ | 通过 |
| 合作申请 | 提交申请 | ✅ | 通过 |
| 智能推荐 | 推荐基地 | ✅ | 通过 |

---

**测试日期**：_____________  
**测试人员**：_____________  
**测试环境**：开发环境 / 生产环境
