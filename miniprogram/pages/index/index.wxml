<!--pages/index/index.wxml-->
<view class="page">
  <view class="header">
    <view class="logo-row">
      <view class="logo">ğŸŒ±</view>
      <text class="title">é‡‡æ‘˜æ™ºå·¥</text>
    </view>
  </view>

  <view wx:if="{{!userInfo}}" class="card welcome-card">
    <view class="welcome-title">æ¬¢è¿ä½¿ç”¨é‡‡æ‘˜é€š</view>
    <view class="welcome-desc">å†œä¸šåŠ³åŠ¨åŠ›å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†å¹³å°</view>
    <button class="btn-primary" bindtap="goToLogin">ç™»å½•</button>
    <button class="btn-register" bindtap="goToRegister">æ³¨å†Œ</button>
  </view>

  <view wx:if="{{userInfo}}" class="content">
    <view class="stats-card">
      <view class="stats-header">
        <view class="user-block">
          <view class="avatar">{{userInfo.name ? userInfo.name[0] : '?'}}</view>
          <view class="user-info">
            <text class="user-name">{{userInfo.name}}</text>
            <text class="user-uid">ç¼–å·: {{userInfo.uid}}</text>
          </view>
        </view>
        <view class="qr-btn" bindtap="goToQrcode">ğŸ“±</view>
      </view>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{workerStats ? workerStats.workDays : '-'}}</text>
          <text class="stat-label">å·²åšå¤©æ•°</text>
        </view>
        <view class="stat-item border-mid">
          <text class="stat-value green">Â¥{{workerStats ? (workerStats.pendingAmount || 0) : '0'}}</text>
          <text class="stat-label">å¾…æ”¶å·¥èµ„</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">-</text>
          <text class="stat-label">ä¿¡ç”¨è¯„åˆ†</text>
        </view>
      </view>
    </view>

    <view class="section">
      <view class="section-title">æ¨èåŸºåœ°</view>
      <view class="section-sub">æ ¹æ®åŒ¹é…åº¦æ¨è</view>
    </view>

    <view wx:if="{{loading}}" class="loading-box">åŠ è½½ä¸­...</view>

    <view wx:elif="{{recommendedBases.length === 0}}" class="empty-box">æš‚æ— æ¨èåŸºåœ°ï¼Œè¯·ç¨åå†çœ‹</view>

    <view wx:else class="base-list">
      <view
        class="base-card"
        wx:for="{{recommendedBases}}"
        wx:key="id"
        bindtap="showBaseJobs"
        data-id="{{item.id}}"
      >
        <view class="base-header">
          <view>
            <text class="base-name">{{item.baseName}}</text>
            <view class="base-meta">
              <text class="base-cat">{{item.categoryName}}</text>
              <text class="base-jobs">åœ¨æ‹› {{item.activeJobsCount || 0}} ä¸ªå²—ä½</text>
            </view>
          </view>
          <text wx:if="{{item.score != null}}" class="base-score">åŒ¹é… {{item.score}}</text>
        </view>
        <view class="base-footer">
          <text class="base-name-small">{{item.baseName}}</text>
          <view class="btn-view">æŸ¥çœ‹å²—ä½</view>
        </view>
      </view>
    </view>
  </view>

  <!-- å²—ä½æŠ½å±‰ -->
  <view wx:if="{{selectedBaseId}}" class="drawer-mask" bindtap="closeJobDrawer"></view>
  <view wx:if="{{selectedBaseId}}" class="drawer">
    <view class="drawer-header">
      <text class="drawer-title">åœ¨æ‹›å²—ä½</text>
      <text class="drawer-close" bindtap="closeJobDrawer">âœ•</text>
    </view>
    <scroll-view class="drawer-body" scroll-y>
      <view wx:if="{{jobsLoading}}" class="loading-box">åŠ è½½å²—ä½â€¦</view>
      <view wx:elif="{{baseJobs.length === 0}}" class="empty-box">è¯¥åŸºåœ°æš‚æ— åœ¨æ‹›å²—ä½</view>
      <view wx:else class="job-list">
        <view class="job-card" wx:for="{{baseJobs}}" wx:key="id">
          <view class="job-header">
            <text class="job-title">{{item.jobTitle || item.title}}</text>
            <text class="job-salary">{{item.salaryText || 'é¢è®®'}}</text>
          </view>
          <text wx:if="{{item.workContent}}" class="job-desc">{{item.workContent}}</text>
          <button
            class="btn-apply {{item.applied ? 'btn-applied' : ''}}"
            disabled="{{applyLoading || item.applied}}"
            bindtap="handleApply"
            data-job-id="{{item.id}}"
            data-base-id="{{selectedBaseId}}"
          >
            {{item.appliedText || 'ç«‹å³æŠ¥å'}}
          </button>
        </view>
      </view>
    </scroll-view>
  </view>
</view>
